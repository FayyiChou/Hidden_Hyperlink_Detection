<!DOCTYPE html><html style="font-size: 0px; "><head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8;">
    <title>收件人评价</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <meta name="apple-touch-fullscreen" content="YES">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style type="text/css">
        html{
            -webkit-text-size-adjust:100%;
            height: 100%;
            width:100%;
        }

        img{vertical-align:bottom;}

        *{
            margin:0;
            padding:0;
            border:0;
            list-style:none;
            -webkit-tap-highlight-color:rgba(255,0,0,0);
            font-family:"微软雅黑";
        }

        a,button,input,textarea{-webkit-tap-highlight-color: rgba(0,0,0,0);-webkit-appearance:none;} 

        body {
            width:100%;
            min-height: 100%;
            line-height: 1.5;
            color: #333;
            position: relative;
            color:#4b4b4b;
        }

        body>div>p {
            line-height: .773rem;
        }

        a, button {
            display: inline-block;
            outline: none;
            text-decoration: none;
        }
        .form-control{
            display:inline-block;
            vertical-align: middle;
        }

        .fl{
            float:left;
        }

        .fr{
            float:right;
        }
        
        .hide{
            display:none;
        }

        .show{
            display:block;
        }

        .clearfix:after{
            content: '';
            display:block;
            clear:both;
        }
        .w28{
            width:28%;
        }
        fieldset{
            border-top:1px solid #dedede;
            padding-top:0.8rem;
            padding-bottom:0.8rem;
            color:#4b4b4b;
            font-size:1.2rem;
        }
        legend{
            padding-left:20px;
            padding-right:20px;
            text-align:center;
            color:#b2b2b2;
            font-size:0.9rem;
            background: #f2f2f2;
        }
        .header{
            font-size:1.2rem;
            font-weight:normal;
            text-align:center;
            color:#fff;
            background: #2facf4;
            height:2.5rem;
            line-height: 2.5rem;
        }
        .content{
            background:#f2f2f2;
            padding:0 20px;
            position:relative;
            z-index:10;
        }

        .content .head_img{
            width:60px;
            height:60px;
            border:1px solid #ddd;
            border-radius:50%;
            margin:12px;
            overflow:hidden;
        }
        .head_img img{
            width:100%;
        }
        .content .head_info{
            margin-top:16px;
        }
        .content .head_info h4{
            font-weight:normal;
            font-size:1.2rem;
            margin-bottom: 0.2rem;
        }
        .content .head_info  p{
            color:#808080;
        }
        .add_icon{
            background:#9dd96a;
            text-align:center;
            border-radius:50%;
            width:30px;
            height:30px;
            line-height:30px;
            color:#fff;
            font-weight:normal;
            font-size:1.1rem;
            margin-left:0.6rem;
            margin-right:0.6rem;

        }
        .add_from{
            width:80%;
        }


        /*配送耗时*/
        .delivery_info_cont{
            text-align: center;
        }
        .delivery_info_cont div{
            text-align:center;
            width:31%;
            display:inline-block;
        }
        .delivery_info_cont span{
            color:#b2b2b2;
            font-size:0.9rem;
        }
        .delivery_info_cont p{
            line-height: 1.2rem;
        }
        /*不满意信息*/
        .misconduct fieldset{
            padding-top:0.8rem;
            padding-bottom:0.6rem;
        }
        .misconduct_items_box{
            width:100%;
            overflow: hidden;
        }
        .misconduct_items{
            width:106%;
            margin-left:-3%;
        }
        .misconduct_items .mis_item{
            float:left;
            width:47%;
            height:2.8rem;
            margin-left:3%;
            margin-bottom:3%;
            background:#ccc;
            text-align:center;
            line-height: 2.8rem;
            color:#808080;
            font-size:1.1rem;
        }
        .misconduct_items .mis_item.active{
            background:#d43f4e;
            color:#fff;
        }
        .misconduct .faq_text{
            width:94%;
            height:6rem;
            padding-left:3%;
            padding-right:3%;
            color:#b2b2b2;
            font-size:1rem;
            resize:none;
            border:1px solid #ccc;
            outline: none;
            padding-top:3%;

        }

        /*星星*/
        
        .block_rank_star{
            text-align: center;
            position: absolute;
            bottom: 4rem;
            left:50%;
            margin-left:-143px;
        }
        .rank_tit{
            color:#ffa018;
            font-size:1.2rem;
            display:block;
        }
        .rank_stars{
            display:inline-block;
        }
        .rank_stars span{
          display:inline-block;
          margin-left:5px;
          margin-right:5px;
          width:44px;
          height:41px;
        }
        .rank_ins{
            color:#d43f4e !important;
        }
        .star_off_xl{
            background:url("/assets/images/star-off-xl.png") left no-repeat;
            background-size: 100%;
        }
        .star_on_xl{
            background:url("/assets/images/star-on-xl.png") left no-repeat;
            background-size: 100%;
        }
        .btn_eval{
           margin-top: 12px;
           position: fixed;
           bottom: 1rem;
           left: 50%;
           margin-left: -47%;
           background:#ffa018;
           height:40px;
           width:94%;
           line-height: 40px;
           text-align: center;
           color:#fff;
           font-size:1.2rem;
           border-radius:1px;
           display:none;
        }

        .btn_redbag{
              width: 95%;
              font-size: 1.2rem;
              color: #fff;
              height: 34px;
              background: #f46720;
              border-radius: 2px;
              margin-bottom: 20px;
              display:none;
        }

    </style>
</head>
<body>
    <div class="header">
        请评价闪送员
    </div>
    <div class="content">
        <div class="content_tit clearfix">
            <div class="head_img fl">
                <img src="">
            </div>
            <div class="head_info fl">
                <h4 class="carrierName"></h4>
                <p>服务次数：<span class="order_total"></span>次</p>
            </div>
        </div>
        <div class="misconduct hide">
            <fieldset>
                <legend>"哪里不满意"</legend>
                <div class="misconduct_items_box">
                    <ul class="misconduct_items clearfix">
                        <!-- <li class="mis_item active">不满意</li>
                        <li class="mis_item">不满意</li>
                        <li class="mis_item">不满意</li>
                        <li class="mis_item">不满意</li>  --> 
                    </ul>
                </div>
                <textarea class="faq_text" placeholder="在此填写您对闪送员的匿名反馈(150字以内)"></textarea>
            </fieldset>
        </div>
        <div class="conduct">
            <fieldset>
                <legend class="finish_time"></legend>
                <label class="form-control add_icon">寄</label>
                <span class="form-control add_from"></span>
            </fieldset>
            <fieldset class="delivery_info">
                <legend>配送信息</legend>
                <div class="delivery_info_cont clearfix">
                    <div>
                        <p class="goods"></p>
                        <span>（物品）</span>
                    </div>
                    <div>
                        <p class="distance"></p>
                        <span>（配送距离）</span>
                    </div>
                    <div>
                        <p class="time_total"></p>
                        <span>(总耗时)</span>
                    </div>
                </div>
            </fieldset>
        </div>
        
    </div>
    
    <div class="block_rank_star">
        <input type="button" class="btn_redbag" value="领取红包">
        <span class="rank_tit">请进行匿名评价</span>
        <div class="rank_stars">
            <span class="star_off_xl"></span>            
            <span class="star_off_xl"></span>            
            <span class="star_off_xl"></span>            
            <span class="star_off_xl"></span>            
            <span class="star_off_xl"></span>            
        </div>
    </div>
    <button class="btn_eval">提交评价</button>
<script type="text/javascript" src="//k.sohu.com/develop/html/activeplugin/04/zepto.min.js"></script>
<script>
    document.documentElement.style.fontSize = document.documentElement.clientWidth/24+'px';
    $(function(){
        $.iss = function(){
            var self = this;

            var doAjax = function(url, dataType, method, data, successCallback, async, errorCallback){
                if (navigator.onLine === false){
                    $.toast({content: '网络已中断，请检查网络连接设置'});
                    return;
                }
                $.ajax({
                    url: url,
                    dataType: dataType || 'json',
                    type: method || 'GET',
                    data: data || {},
                    async: async === false ? false: true,
                    complete: function(res){
                        var resp = $.parseJSON(res.responseText);
                        if (resp.status === 200){
                            if (successCallback){
                                successCallback(resp.data);
                            }
                        } else if(resp.status === 302){
                            window.location.href = resp.data;
                        } else {
                            if (errorCallback){
                                errorCallback(resp.err);
                            } else {
                                $.toast({
                                    content: resp.err
                                });
                            }
                        }
                    }
                });
            };

            this.getQueryString = function(name){
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r !== null) return unescape(r[2]); return null;
            };

            /*请求数据*/
            this.getReciverRankPrepareInfo = function(orderNumber, receiverMobile,sm,callback){
                doAjax('/hpi/ranks/receiver/prepare', 'json', 'GET', {orderNumber:orderNumber,receiverMobile:receiverMobile,sm:sm}, callback);
            };

            this.submitReciverRank = function(data, callback){
                doAjax('/hpi/ranks/receiver/submit', 'json', 'POST', data, callback);
            };

            this.renderStars = function(starsVal){
                for(var i=0;i<starsVal;i++){
                    $('.rank_stars').find('span').eq(i).addClass('star_on_xl');
                }
            };

            this.onValChange = function(){
                var fleft = $('.rank_stars').offset().left;
                var W1 = $('.rank_stars').children().width()+10;
                function change(index){
                        var rank_ins=['非常不满意','不满意','一般','满意','非常满意'];
                        $('.rank_stars').find('span').removeClass('star_on_xl');
                        self.renderStars(index+1);
                        $('.rank_tit').text('匿名评价：').css({'fontSize':'1rem','color':'#828282'}).append('<b class="rank_ins">'+rank_ins[index]+'</b>');
                        if(index < 3){
                            $('.misconduct').show();
                            $('.conduct').hide();
                        }else{
                            $('.misconduct').hide();
                            $('.conduct').show();
                        }
                        $('.btn_eval').show();
                        dataList.score = index+1;
                        if(dataList.score > 3){
                            dataList.misconductIds = '';
                            dataList.feedback = '';
                        }
                        console.log(dataList.score);
               }

                $('.rank_stars').find('span').on('touchstart',function(ev){
                    var index = $(this).index();
                    change(index);

                });
                $('.rank_stars').on('touchmove',function(ev){
                    ev.preventDefault();
                    var touch = ev.targetTouches[0];
                    var left = touch.pageX;
                    var disX = left - fleft;
                    var n = Math.floor(disX/W1);
                    if(n>=0 && n<5){
                        change(n);
                    }
                });
            };
            //创建不满意标签
            this.createMisconduct = function(data){
                var oLi = $("<li>").text(data.name).data('id',data.id).addClass('mis_item').appendTo('.misconduct_items');
            };

            this.getEnvironment = function(){
                var hostname    = window.location.hostname;
                if(/bingex/.test(hostname)){
                    return 'dev';
                }
                else if(/ishansong/.test(hostname)){
                    return 'online';
                }
            };
            // 获取图片host地址
            this.getImgHost = function(){
                if('online' === this.getEnvironment()){
                    return '//s.ishansong.com';
                }else if('dev' === this.getEnvironment()){
                    return '//www.bingex.com/files';
                }
            };
            return self;
        };

        /*定义初始变量*/
        var score=0,
            carrierName='',
            orderTotal=0,
            feedback='',
            misconductIds='',
            status=0,
            imgUrl='',
            order={},
            misconducts=[],
            rankRecord={},
            finishTime=0,
            pickTime=0,
            sendTime=0
            readOnly=false;


        var orderNumber = $.iss().getQueryString('orderNumber');
        var receiverMobile = $.iss().getQueryString('receiverMobile');
        var sm = $.iss().getQueryString('sm');

        $.iss().getReciverRankPrepareInfo(orderNumber,receiverMobile,sm,function(res){
            //获取初始值
            misconducts = res.misconducts;
            for(var i=0;i<misconducts.length;i++)
            {
                $.iss().createMisconduct(misconducts[i]);
            }
            orderTotal=res.orderTotal || 0;
            status=res.status || 0,
            imgUrl=res.imgUrl,
            order=res.order,
            misconducts=[],
            rankRecord=res.rankRecord || {};
            finishTime=res.ftime;
            pickTime=res.ptime;
            sendTime=res.dtime;

            //闪送员名字
            $('.carrierName').text(order.carrierName);

            //闪送员图像
            $('.head_img img').attr('src', $.iss().getImgHost() + imgUrl);

            //服务次数
            $('.order_total').text(orderTotal);

            //完成时间
            var finish = formatDate(finishTime);
            $('.finish_time').text(finish);

            
            if(!order.tasks){
                return null;
            }
            //寄件地址
            var t = order.tasks[0];
            var fromAddr = t.fromAddr;
            $('.add_from').text(fromAddr);

            //如果是一取多投，就不显示配送信息 待定
            if(order.tasks.length > 1){
                $('.delivery_info').hide();
            }
            //物品
            var goods = t.goods;
            $('.goods').text(goods);
            //距离
            var distance = t.distance/1000;
            $('.distance').text(distance+'公里');
            //总耗时
            var ptime = Math.floor(parseFloat(pickTime)/60000);
            var timeTotal = ptime+sendTime;
            $('.time_total').text(timeTotal+'分钟');

            //点击不满意标签
            var mis = [];
             $('.mis_item').on('click',function(){
                    if($(this).hasClass('active')){
                        $(this).removeClass('active');
                        mis.splice(mis.indexOf($(this).data('id')),1);
                    }else{
                        $(this).addClass('active');
                        mis.push($(this).data('id'));
                    }
                    if(mis.length == 1){
                        dataList.misconductIds = mis[0];
                    }else{
                        dataList.misconductIds = mis.join(',');
                    }
                    console.log(dataList.misconductIds);
            });

            //判断是否已评价
            var star = rankRecord.star || 0;
            if(status == 1){
                $('.rank_tit').text('评价成功');
                $.iss().renderStars(star);
                $('.btn_redbag').show();
            }else{
                $.iss().onValChange();
            }
        });

        $('.faq_text').on('change input',function(){
            dataList.feedback = $('.faq_text').val();
        });


        //准备数据
        var dataList={
            orderNumber:orderNumber,
            score:0,
            misconductIds:'',
            feedback:'',
            receiverMobile:receiverMobile
        }
        console.log('mis:'+dataList.misconductIds);
        console.log('score:'+dataList.score);

        //点击提交
        $('.btn_eval').on('touchstart',function(){
            console.log(JSON.stringify(dataList));
            $.iss().submitReciverRank(dataList,function(){
                window.location.reload();
            });
        });

        //点击领取红包
        $('.btn_redbag').on('touchstart',function(){
            $(this).css('backgroundColor','#ff7b38');
            $.ajax({
                url:"/hpi/activities/shared_red_envelop",
                data:{from:"recipientRank"},
                success:function(res){
                    console.log(res);
                    var data = res.data;
                    if(data){
                        window.location.href='red_bag.html?iss_from='+data+'&mobile='+receiverMobile;
                    }
                    
                }
            });
            
        });

        $('.btn_redbag').on('touchend',function(){
            $(this).css('backgroundColor','#f46720');
        });
        
        // $.iss().onSubmitRank(dataList);

        //获取屏幕尺寸
        var width = $(document).width();
        var height = $(document).height();
        var r = height/width;
        if(r <= (4/3)){
            $('.delivery_info').hide();
            $('.btn_redbag').css('marginBottom','5px');
        }

        //格式化时间
        function formatDate(time){
            //获取当前时间 格式化
            var oDate=new Date(time);
            var year = oDate.getFullYear();
            var month = oDate.getMonth();
            var date = oDate.getDate();
            var hour = oDate.getHours();
            var curTime = toDub(month+1)+'月'+toDub(date)+'日'+' '+toDub(hour)+'点';

            function toDub(n){
                return n<10?'0'+n:''+n;
            }

            return curTime;
        }
    });
</script>













</body></html>
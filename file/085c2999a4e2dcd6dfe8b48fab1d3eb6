<html><head></head><body><pre style="word-wrap: break-word; white-space: pre-wrap;">/**
 * @Created by longlong on 2015/6/16.
 * @description RoomController用于进入房间相关业务。如：进入房间，加载房间信息，房间等级，房间权限等
 * @class：依赖nodeHttp、userManager，roomView，searchController
 */

var _roomname=null;
var _lecturername=null;

(function(){
    var root;
    var This;
    var userManager;
    var noticeTime ;
    var showWhiteBox=false;    //默认没有迎宾语和广播
    var kickusers=[];
    var RoomData={
            id:RoomHash,
            name:"",
            sensitiveword:"",
            messagelength:"",
            c_repeat:0,
            c_msg_rate:1.5,
            msg_length:20
        };
    var notice;
    var RoomController = function(_root){
        root = _root;
        This = this;
       // this.connectUrl = reborn.constant.ConnectUrl;
        this.nodeHttp = root.nodeHttp;
       // this.domain = this.connectUrl.DOMAIN;
      //  this.regdomain = this.connectUrl.REGDOMAIN;
      //  this.mfservice = this.connectUrl.MFSERVICE;
        this.socketController = root.socketController;
        this.bindEvent();
        This.loadTalk();

    };
    var rid;
    RoomController.prototype = {

        loadTalk:function(){
            $(".preloading").show();
            $.getJSON("http://video.bjjinnian.com/web/roomlinemobile.php?action=getRoomChatRecord&amp;c_hash="+RoomData.id+"&amp;act=list&amp;callback=?",function(talkdata){
                $(".preloading").hide();
                //console.debug("=====RoomController 数据=====::",talkdata);
                //This.chatView.checkGuest(data);

                for(var i=0;i&lt;talkdata.length;i++){

                    var data=talkdata[i];
                    //alert("请求回来的数据长度:"+talkdata.length+"::data.uid::"+data.uid);
                        var datamsg = data.msg;
                        var repValue = datamsg;
                        var reg =/\([^\)]+\)/ig;
                        var matMsgArr = datamsg.match(reg);
                        if(matMsgArr&amp;&amp;matMsgArr.length&gt;0){
                            for(var i = 0;i&lt;matMsgArr.length;i++){
                                var imgName = matMsgArr[i].replace(/\(|\)/ig,"");
                                repValue = repValue.replace(matMsgArr[i],"&lt;img src=images/emoj/"+imgName+"&gt;");
                            }
                        }
                        datamsg = repValue;
                        //解析花
                        data.msg=datamsg;

                        var messagecontent=decodeURI(data.msg);
                        messagecontent=messagecontent.replace(/images\/emoj/g,"http://c.mfniu.com/mfvideo/images/emoj/");
                        //console.log("datastyle-----&gt;",data.style)
                        var styler = undefined;
                        /*if(data.type == 0){
                         styler=undefined;
                         }else{
                         styler = data.style;
                         };*/
                    data.tuid="";
                    //roomController.getCurTime()
                    var getCurTime=function(){
                        var date=new Date();
                        var getMinutes = date.getMinutes();
                        if(getMinutes&lt;10){
                            getMinutes="0"+getMinutes;
                        }
                        var getSeconds = date.getSeconds();
                        if(getSeconds&lt;10){
                            getSeconds="0"+getSeconds;
                        }
                        return date.getHours()+":"+getMinutes+":"+getSeconds;
                    }
                    var curtime=getCurTime();
                            if(data.tuid==""){

                                if(data.uid&gt;0){
                                    $(".msgContentTop").append("&lt;li class='msg"+data.uid+"'&gt;&lt;span  uid='"+data.uid+"' class='blueColor nameBtn2'&gt;&lt;b&gt;"+data.nickname+"&lt;/b&gt;&lt;/span&gt;说:&lt;em style='"+styler+"'&gt;"+messagecontent+"&lt;/em&gt;("+curtime+")&lt;/li&gt;");
                                };
                                if(data.uid==userInfo.uid+""){
                                    $(".msgContentTop").append("&lt;li class='msg"+data.uid+"'&gt;&lt;span  uid='"+data.uid+"' class='blueColor nameBtn2'&gt;&lt;b&gt;"+data.nickname+"&lt;/b&gt;&lt;/span&gt;说:&lt;em style='"+styler+"'&gt;"+messagecontent+"&lt;/em&gt;("+curtime+")&lt;/li&gt;");
                                };
                                //if()
                            }else{

                                    if(data.nickname.indexOf("游客")){
                                        $(".msgContentTop").append("&lt;li class='msg"+data.uid+"'&gt;&lt;span uid='"+data.uid+"' class='blueColor nameBtn2'&gt;&lt;b&gt;"+data.nickname+"&lt;/b&gt;&lt;/span&gt;对&lt;span  uid='"+data.utid+"' class='blueColor nameBtn'&gt;&lt;b&gt;"+data.tnickname+"&lt;/b&gt;&lt;/span&gt;说:&lt;i style='"+styler+"'&gt;"+messagecontent+"&lt;/i&gt;("+roomController.getCurTime()+")&lt;/li&gt;");
                                    }
                            }

                        if($(".msgContentTop").find("li").length&gt;=50){
                            $(".msgContentTop").find("li:lt(20)").remove();
                        }
                    }//for
                });

        },
		nowTeacher:null,
        bindEvent: function () {
            //$("body").on("click", ".roomclick,.hotroomlist", This.initRoom);//进入房间
            this.socketController.socketLink();
            setTimeout(function(){
                This.initRoom();
            },1000);

            //聊天发送信息
            $("body").on("click","#chat_msgSendBtn",function(){

                This.sendMessage()
            });

            //点击获取管理员信息
            $("body").on("click",".adminUserList li",function(){
                This.clickAdmin(this);
            });
            
            //点击获取表情的显示与隐藏
            $("body").on("click",".smile",function(){
                This.clickSmile(this);
            }); 
            

            //点击获取聊天表情信息
            $("body").on("click",".emojImgs td img",function(){

                This.showEmojImgs(this);
            });

            //鼠标滑过表情块消失
            $("body").on("mouseleave",".emjCon",function(){
                This.leaveEmojImgs(this);
            });  

            //点击显示广播信息
            $("body").on("click","#room_broadcast",function(){
                This.MobileBroadcast(this);
            }); 

            $("body").on("click",".qianyan",function(){
                window.location.href="http://www.qyniu.com";
            });
			
			//点击全民淘股
			$("body").on("click",".taogu",function(){
				if(This.nowTeacher){
					var luid=This.nowTeacher.uid?This.nowTeacher.uid:"";
				}
				else{
					var luid="";
				}
                window.location.href="http://ma.wybi.net/?k=107vay9&amp;luid="+luid+"&amp;hash="+RoomData.id;
            });
			//点击手机APP
			$("body").on("click",".phoneApp",function(){
				if(This.nowTeacher){
					var luid=This.nowTeacher.uid?This.nowTeacher.uid:"";
				}
				else{
					var luid="";
				}
                window.location.href="http://ma.wybi.net/?k=107vayq&amp;luid="+luid+"&amp;hash="+RoomData.id;
            });

            
            $("body").on("click",".yunnao",function(){
                window.location.href="http://yun.17mf.com";
            });

            $("body").on("click",".privite-content",function(){
                $(".privite-content").fadeOut();
                $(".public-content").css("top",0);
            }); 

            // 点击关闭底部广告
            $("body").on("click",".moblieClose",function(){
                $(".moblieAdvert").fadeOut();
            }); 

            $("body").on("click",".moblieChart",function(){
                 $(".video-bottom").show();
            });
            $("body").on("click",".Moblienew",function(){
               $(".video-bottom").hide();
               $(".broadcastWindow").hide();
               $("#divmask").hide();
               This.MobileRoomBroadcast(rid); 
            });
            
            $("body").on("click",".moblieMore",function(){
                 $(".video-bottom").hide();
                 $(".broadcastWindow").hide();
                $("#divmask").hide();
            });

            /*
            $("body").on("click","#room_broadcast",function(){
             This.MobileRoomBorWelcome(rid);
            });
            */

            $("body").on("touchend",".broadcastEject-gift",function(){  //click
               // This.MobileRoomBorWelcome(rid);
                //alert("你是瑟瑟发送是是算法算法萨斯色粉二手房艾丝凡色发生发送饭额爱儿色肤色饭发送粉色分");
                $(".broadcastWindow").show();
                $("#divmask").show();
                $(".newcls").hide();
            });
            /*
            $("body").on("touchend",".broadcastEject",function(){
                // This.MobileRoomBorWelcome(rid);
                alert("你是瑟瑟发送是是算法算法萨斯色粉二手房艾丝凡色发生发送sd分");
                $(".broadcastWindow").show();
                $("#divmask").show();
                $(".newcls").hide();
            });
            */



            $("body").on("click",".broadcastWindow-close",function(){
                $(".broadcastWindow").hide()
                $("#divmask").hide();
            });
			
			//关闭下载弹框
			$("body").on("click",".downLoadClose",function(){
                $(".downLoad,.black").hide();
            });

            //点击下载钱眼客户端
            $("body").on("click",".downLoad a",function(){
                $.ajax({
                    url:"http://video.bjjinnian.com/newVideoPHP/web/qianyan.php?action=qianYanDowloadCount&amp;c_hash="+userInfo.rid+"&amp;uid="+userInfo.uid,
                    dataType:"jsonp", 
                    type:"GET",
                    success:function(data){
                        //console.log("点击量加一",data,data.result);
                        if(data.result.indexOf("ok")&gt;=0)
                        window.location.href="http://ma.wybi.net/?k=107vayr";
                    }
                });
            });

            

        },
        leaveEmojImgs : function(obj){
            var _this=$(obj);
            $(".smile").removeAttr("key");
            setTimeout(function(){_this.hide();},500);
        },

        //获取广播
        MobileBroadcast : function(obj){
            //showWhiteBox

            var event = window.event || e;
            event.stopPropagation();
            if($(obj).attr("key")!=undefined){
                $(".broadcast").stop().animate({"right":0 + "px"}, 460, function(){
                    $(obj).css("right",0);
                    $(".broadcast-bgcolor").find("img").attr("src","http://c.mfniu.com/MobileWeb/images/broadcastClose.png");
                    $(".broadcast-content").show();
                });
                $(obj).removeAttr("key");
            }else{
                $(".broadcast").stop().animate({"right": -255 + "px"}, 460);
                $(".broadcast-bgcolor").find("img").attr("src","http://c.mfniu.com/MobileWeb/images/broadcast.png");
                $(".broadcast-content").show();
                $(obj).attr("key",0);
            }
        },

        clickAdmin : function(obj){

            $(".btn-admin").text($(obj).attr("nickname"));
            $(".owner").attr("nickname",$(obj).attr("nickname"));
            $(".owner").attr("uid",$(obj).attr("uid"));
            $(".owner").attr("area",$(obj).attr("area"));
        },

        hidelay: function(){
            $(".emjCon").stop().animate({ 'top': 0 }, 500, function(){
                $(".emjCon").css({"opacity": 0, "display": "none"})
            });
        },

        clickSmile : function(obj){
            var event = window.event || e;
            event.stopPropagation();
            if($(obj).attr("key")!=undefined){
                //This.hidelay();
                $(".emjCon").fadeOut();
                $(obj).removeAttr("key");
            }else{
                //$(".emjCon").css({"opacity": 1, "display": "block"}).stop().animate({ 'top': -123 }, 500);
                $(".emjCon").fadeIn();
                $(obj).attr("key",0);
            }
        },

        showEmojImgs : function(obj){
            var msg=$(".talks-box").val();
            var src=$(obj).attr("src").replace("http://c.mfniu.com/mfvideo/images/emoj/","").replace("_thumb.gif","");
            //console.log("src-----&gt;",src);
            $(".talks-box").val($(".talks-box").val()+"[-:"+src+":-]");
        },

        //初始化房间数据
        initRoom: function () {
            if(!ChatApp){
                utils.tips({content:"网络错误,建议重新登录"});
                return;
            }

            $(".broadcastWindow").hide(); //隐藏上面窗口
            $("#divmask").hide();
            $(".newcls").hide();

            rid=RoomData.id;
            This.MobileRoomQq(rid);
            This.MobileRoomName(rid,RoomData);
            This.MobileRoomNum(rid);
            This.MobileRoomWelcome(rid);
            //This.MobileRoomBroadcast(rid)
            This.MobileRoomadmin(rid);
            This.MobileRoomMac(rid,RoomData);
            This.MobileRoomBorWelcome(rid);
           // This.roomNotice();
        },

        // 检测敏感词
        isSensitive : function(msg){
            msg = this.removeHTMLTag(msg); 
            var sensitiveword=RoomData.sensitiveword;
            var senHave=false;
            if(sensitiveword.length&gt;0){
                var senArray=sensitiveword.split(",");
                // senArray.push('sb');
                for(var i=0;i&lt;senArray.length;i++){
                    if(senArray[i]){
                        if(msg.indexOf(senArray[i])!=-1){
                            senHave=true;
                            break;
                        }
                    } 
                }
            } 
            return senHave;
        },
        //获取时间
        getCurTime : function(){
            var date=new Date();
            var getMinutes = date.getMinutes();
            if(getMinutes&lt;10){
                getMinutes="0"+getMinutes;
            }
            var getSeconds = date.getSeconds();
            if(getSeconds&lt;10){
                getSeconds="0"+getSeconds;
            }
            return date.getHours()+":"+getMinutes+":"+getSeconds;
        },

        // 保持在底部
        goToBottom : function(d){
            if(d.attr("sc")=="no"){
                //
            }else{
                d.scrollTop(d[0].scrollHeight);
            }
        },

        insertSystem : function(){
            if(arguments.length&gt;0){
                $(".systemContent").append(arguments[0]);
                This.goToBottom($(".chartContentMb"));
            }else{
                $(".systemContent").html("");
            }
        },
        //广播
        insertBroadcast : function(){
            if(arguments.length&gt;0){
                $(".laba-system-public").append(arguments[0]);

                var img = $(".laba-system-public").find("img");



            }else{
                $(".laba-system-public").html("");
            }
        },
        //敏感词
        removeHTMLTag : function(str){
            str = str.replace(/&lt;img \/?[^&gt;]*&gt;/g,' '); //去除HTML tag
            str = str.replace(/&lt;\/?[^&gt;]*&gt;/g,'');
            str = str.replace(/[ | ]*\n/g,'\n'); //去除行尾空白
            //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
            str=str.replace(/&amp;nbsp;/ig,'');//去掉&amp;nbsp;
            return str;
        },

        mergeJson : function(jsonbject1, jsonbject2){
            var resultJsonObject={};  
            for(var attr in jsonbject1){  
                resultJsonObject[attr]=jsonbject1[attr];  
            }  
            for(var attr in jsonbject2){  
                resultJsonObject[attr]=jsonbject2[attr];  
            }  
            return resultJsonObject; 
        },

        //获取房间信息
        MobileRoomName : function(roomid,RoomData){

            $.getJSON("http://video.bjjinnian.com/web/chatroom.php?action=getchatroom&amp;c_hash="+roomid+"&amp;callback=?",function(data){
                //房间名称

                console.debug("====MobileRoomName====:",data);
                var roomName = data.c_chatroom_name?data.c_chatroom_name:"";
                $(".rname").html(data.c_chatroom_name);
                //document.title=data.c_chatroom_name;
                _roomname="";//data.c_chatroom_name;
                document.title=_roomname;
                //房间公告
                notice = data.c_notice_m ? data.c_notice_m : "";
                //var addstring = "";
                //addstring += "&lt;div class='notice' &gt;"+notice+"&lt;/div&gt;";
                $(".notice").html(notice);
                $.extend(RoomData,{c_forward:data.c_forward,name:data.c_chatroom_name,sensitiveword:data.sensitiveword,messagelength:data.messagelength,c_repeat:data.c_repeat,c_msg_rate:data.c_msg_rate,c_description:data.c_description,qq:data.qq});
            })
        },
        //分享QQ
        MobileRoomQq : function(roomid){
            var qqteam=[];
            var prizeQQ=0;
            $.getJSON("http://video.bjjinnian.com/web/chatroom_extend.php?act=getroomqq&amp;room_hash="+roomid+"&amp;callback=?",function(data){
                var data = eval("("+data+")");
                if(!data.qq){
                    return false
                }else{
                    qqteam=data.qq.split(",");
                    //prizeQQ=qqteam[(Math.floor(Math.random()*10))%qqteam.length];
                    prizeQQ = qqteam[0];
                    $(".shareQQ").find("span").text(prizeQQ)
                }
            });
        },

        //房间人数
        MobileRoomNum:function(roomid){
            $.getJSON("http://video.bjjinnian.com/web/onlinelist.php?action=listcount&amp;c_hash="+roomid+"&amp;act=list&amp;callback=?",function(data){
                //console.log("房间人数------&gt;",data);
                var onlineNumber = data.num ? parseInt(data.num) : 0;
                var c_robot_num = data.c_robot_num ? parseInt(data.c_robot_num) : 0;
                onlineNumber=onlineNumber+c_robot_num;
                $(".rcount").html(onlineNumber);
            })
        },
        //获取房间迎宾语
        MobileRoomWelcome : function(roomid){
            $.getJSON("http://video.bjjinnian.com/web/welsysmg.php?action=getwelcome&amp;c_hash="+roomid+"&amp;callback=?&amp;c_usertype=3",function(data){
                //console.debug("MobileRoomWelcome 房间迎宾语1111--------&gt;",data);
                if(data.length == 0){
                    $(".broadcast").hide();
                    return;
                }
                if(data.length&gt;0){
                    var data=data[0];
                    //This.insertBroadcast("&lt;div&gt;"+data.c_msgbody+"&lt;/div&gt;")

                    $(".broadcast-content").html(data.c_msgbody);
                    $(".broadcastWindow-content").html(data.c_msgbody);//有迎宾语点击显示迎宾语

                    $(".broadcast-content").find("a").removeAttr("href");
                    var broadcastImg = $(".broadcast-content").find("img");
                    var pic_width, pic_height;
                    broadcastImg.attr("src", $(broadcastImg).attr("src")).load(function() {
                        pic_width = this.width;   
                        pic_height = this.height; 
                        if(pic_width&gt;180 &amp;&amp; pic_height&gt;120){
                            $(".broadcast-content").find("img").attr("style","width:180px;height:80px") 
                        }
                    });

                    //This.run();

                }
            });
        },

        //房间迎宾语  框
        MobileRoomBorWelcome : function(roomid){
             $.getJSON("http://video.bjjinnian.com/web/welsysmg.php?action=getwelcome&amp;c_hash="+roomid+"&amp;callback=?&amp;c_usertype=3",function(data){
                //console.log("MobileRoomBorWelcome房间广播迎宾语--------&gt;",data);
                 //console.debug("房间广播迎宾语--------&gt;",data);
                 //broadcastWindow
                if(data.length&gt;0){
                    var data=data[0];
                    //$(".welcomeInit").html(data.c_msgbody);
                    showWhiteBox=true;
                    //$("#welcometaik").html(data.c_msgbody);
                    $("#welcometaik").hide();
                    $("#room_broadcast").hide();

                    $(".welcomeInit").find("a").removeAttr("href");
                    $(".broadcastWindow").show();  //显示 迎宾因
                    $("#divmask").show();
                    setTimeout(function(){
                        $(".broadcastWindow").hide();
                        $("#divmask").hide();
                    },5000);
                    $("#broadcast").show();  //隐藏老迎宾语
                }else{
                    if(showWhiteBox==false){
                        var contentheight=(parseInt($(".broadcastWindow").outerHeight())/2);
                        contentheight=contentheight-50;
                        $(".broadcastWindow-content").html("&lt;div style='text-align: center;margin-top:"+contentheight+"px;font-family: 字体;font-size: 28px;color: #68ade3;'&gt;主播暂时没发礼物,请稍后...&lt;/div&gt;");

                        //$(".broadcastWindow").show();  //显示 迎宾因
                        /*
                        setTimeout(function(){
                            $(".broadcastWindow").hide();
                            $("#divmask").hide();
                        },5000);
                        */
                    }
                }
             })
        },
       
        //广播列表
        MobileRoomBroadcast : function(roomid){
             $.getJSON("http://video.bjjinnian.com/web/roombroadcast.php?action=getBHistory&amp;c_hash="+roomid+"&amp;callback=?",function(res){
				//console.log("广播列==============表",res);
				var data =res.data;
				var Broadcast = "";

                for (var i = 0; i &lt;data.length; i++) {
                    showWhiteBox=true;
					data[i]=JSON.parse(data[i]);
                    console.log("data[i]------&gt;",data[i]);
                    var c_msgbody = data[i].c_msgbody ? data[i].c_msgbody : "";
                    Broadcast+="&lt;li class='BroadcastList'&gt;"+c_msgbody+"("+This.getCurTime()+")&lt;/li&gt;";

                    if(i==(data.length-1)){
                        $(".broadcastWindow-content").html(data[i].c_msgbody);
                        $(".newcls").show();
                    }
                };
               $(".roombroadcast ul").append(Broadcast);

               if(data.length&lt;=0){
                   if(showWhiteBox==false){
                       //console.debug(".broadcastWindow hegigt::",$(".broadcastWindow").outerHeight());
                       var contentheight=(parseInt($(".broadcastWindow").outerHeight())/2);
                       contentheight=contentheight-50;
                       $(".broadcastWindow-content").html("&lt;div style='text-align: center;margin-top:"+contentheight+"px;font-family: 字体;font-size: 28px;color: #68ade3;'&gt;主播暂时没发礼物,请稍后...&lt;/div&gt;");
                       $(".broadcastWindow").show();  //显示 迎宾因
                       setTimeout(function(){
                           $(".broadcastWindow").hide();
                           $("#divmask").hide();
                       },5000);
                   }else{
                       showWhiteBox=true;
                   }
               }
               
            });
            This.MobileRoomBroadcast= null;
        },


        //获取管理列表
        MobileRoomadmin : function(roomid){
            $.getJSON("http://video.bjjinnian.com/web/onlinelist.php?action=roomadmin&amp;c_hash="+roomid+"&amp;callback=?",function(data){
                var roomAdmin = "";
                for(var i=0;i&lt;data.length;i++){
                    if ($(".userlist" + data[i].uid).length &lt; 1){  
                        $(".adminUserList").prepend('&lt;li class="clearfix userlist' + data[i].uid + '" nickname="' + data[i].nickname + '" uid="' + data[i].uid + '" type="'+data[i].type+'" area="room"&gt;&lt;a href="javascript:;"&gt;&lt;span&gt;' + data[i].nickname + '&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;');               
                    }
                }
            });
        },

        //消息发送
        emitMsg : function(style,msg){
            style=encodeURIComponent(style);
            //console.log("style------&gt;",style);
            console.log("stylemsg------&gt;",msg);

            //msg=msg.replace(/\[-:/g,"&lt;img src='images/emoj/").replace(/:-\]/g,"_thumb.gif'/&gt;");
            msg=msg.replace(/\[-:/g,"&lt;img src=\"images/emoj/").replace(/:-\]/g,"_thumb.gif\"&gt;");

            //msg=msg.html();

            //去掉 字符串
           var dome= document.createElement("div");
            dome.addClass="talks-box";
            document.body.appendChild(dome);
            $(".talks-box").html(msg);

            var imgArr =$(".talks-box").html(msg).find("img");

            document.body.removeChild(dome);
            //var imgArr =(msg).find("img");
            var repValue = msg;
            /*****************************************
             * 发送消息表情时，将表情样式过滤掉，只传表情名称 *
             * 在接收端再拼装样式                       *
             ****************************************/
            if(imgArr.length&gt;0){
                for(var i =0;i&lt;imgArr.length;i++){
                    var lth= (imgArr[i].src).split("/");
                    var imgName = lth[lth.length-1];
                    var ihtml = imgArr[i].outerHTML.toLowerCase();
                    //utils.log("ChatController.js :: enter ihtml =========="+ihtml.toLowerCase());
                    repValue = repValue.replace(ihtml,"("+imgName+")");
                    console.log("repValue ===="+repValue+"----ihtml ====="+ihtml);
                }
            }
            msg = repValue;
            //去掉 字符串

            // 20151026修改 发言字数限制的bug
            var msgLen=This.removeHTMLTag(msg).length;
            if(msgLen&gt;0){
                //RoomData.msg_length
                if(msgLen&lt;RoomData.messagelength||msgLen==RoomData.messagelength){
                    //msg=encodeURIComponent(msg.replace(/script/ig,"").replace(/style/ig,""));
                    msg=msg.replace(/script/ig,"").replace(/style/ig,"");

                    if($(".owner").attr("uid")=="all"){
                        var data={"uid":userInfo.uid,"nickname":userInfo.nickname,"msg":msg,"area":"room","style":style,"rid":RoomHash,"tuid":"","tnickname":"","talktype":1};
                    }else{
                        if($(".owner").attr("area")=="room"){
                            var data={"uid":userInfo.uid,"nickname":userInfo.nickname,"msg":msg,"tuid":$(".owner").attr("uid"),"tnickname":$(".owner").attr("nickname"),"area":"room","style":style,rid:RoomHash,"talktype":1};
                        }else{
                            var data={"uid":userInfo.uid,"nickname":userInfo.nickname,"msg":msg,"tuid":$(".owner").attr("uid"),"tnickname":$(".owner").attr("nickname"),"area":"cross","style":style,rid:RoomHash,"talktype":1};
                        }
                    }
                    if(ChatApp.getState()) {
                        var contentobj=this.mergeJson(data,userInfo);
                        ChatSocket.emit("message", {
                            event: "talk",
                            data: contentobj
                        });
                    }else{
                        alert("网络断开，发送失败");
                    }
                    $(".talks-box").val("");   
                }
                else{
                    alert("发言程度超出管理员限制");
                }
            }
        },
        //发送信息
        sendMessage : function(){

            if($.cookie('kickUsers')){
                //console.log("RoomData------&gt;",RoomData);
                //console.log("userInfo------&gt;",userInfo);
                if($.cookie('kickUsers').indexOf(""+userInfo.uid+"")!=-1){
                    alert("请不要破坏公共环境，多谢！");
                }else{
                    var msg=$(".talks-box").val();
                    var style=$(".talks-box").attr("style");
                    //过滤敏感词
                    var sensitiveword = RoomData.sensitiveword;
                    var sendOk=true;
                    if( sensitiveword != null  &amp;&amp; sensitiveword != ''){
                        sensitivewordArray = sensitiveword.split(',');
                        for(var i=0;i&lt;sensitivewordArray.length;i++){      
                            if(msg.indexOf(sensitivewordArray[i]) &gt;= 0 ){
                                sendOk=false;
                                break;
                            }
                        } 
                    }
                    if(sendOk){
                        This.emitMsg(style,msg);
                    }else{
                        alert("不能发送受限内容");
                    }
                }
            }else{
                var msg=$(".talks-box").val();
                var style=$(".talks-box").attr("style");
                //过滤敏感词
                var sensitiveword = RoomData.sensitiveword;
                //console.log("sensitiveword222-------------&gt;",sensitiveword);
                var sendOk=true;
                if( sensitiveword != null  &amp;&amp; sensitiveword != ''){
                    sensitivewordArray = sensitiveword.split(',');
                    for(var i=0;i&lt;sensitivewordArray.length;i++){      
                         if(msg.indexOf(sensitivewordArray[i]) &gt;= 0 ){
                                 sendOk=false;
                                 break;
                         }
                    } 
                }

                if(sendOk){
                    This.emitMsg(style,msg);
                }else{
                    alert("不能发送受限内容");
                }
            }
        },

        //麦序切换
        MobileRoomMac : function(roomid,RoomData){
            $.getJSON("http://video.bjjinnian.com/web/roommac.php?action=getmac&amp;c_hash="+roomid+"&amp;act=getmac&amp;callback=?",function(res){
                console.debug("res2-------&gt;",res);
                //alert("1111"+res.uid);
                //_rooname
                if(res.nickname==null){
                    _lecturername="";
                }else{
                    _lecturername=res.nickname+"正在直播";
                }
                document.title=document.title+""+_lecturername;

                if(res.uid == null){
                    if(RoomData.c_forward.length&lt;32) return;

                    $.getJSON("http://video.bjjinnian.com/web/roommac.php?action=getmac&amp;c_hash="+RoomData.c_forward+"&amp;act=getmac&amp;callback=?",function(mainmac){
                        //console.debug("res1-------&gt;",res);
                        console.log("mainmac----&gt;",mainmac);
                        var teacher = mainmac;
						This.nowTeacher=mainmac;  //讲师信息
                        //console.log("teacher-------&gt;",teacher);
                        if(mainmac.uid==null){ 

                        }else{
                            //http://hls.live.mfniu.com/tjapp/4831b629af8e2f98682eb1a78dc6ad21/index.m3u8

                            console.log("切脉播放地址:"+"http://hls.live.mfniu.com/tjapp/"+teacher.hash+"/index.m3u8");
                           // $("video").attr("src","http://hls.live.mfniu.com/tjapp/"+teacher.hash+"/index.m3u8");
                            //$("video").attr("src","http://117.121.31.196/mobilepage/media/ceshi.mp4");  //./media/ceshi.mp4  http://123.130.117.40/v58525852-48069256__1004308_hls/playlist.m3u8

                            //$("video").attr("src","http://hls.live.mfniu.com/tjapp/"+teacher.hash+"_aac/playlist.m3u8");
                            //$("video").attr("src","http://wshls.mfniu.com/tjapp/"+teacher.hash+"_aac/playlist.m3u8");
                            //$(".video-name").text(teacher.nickname);


                                //document.getElementById("video").preload();
                                document.getElementById("video").load();
                                document.getElementById("video").play();
                                //htmlstr="&lt;div&gt;=延时11 视频 切换视频&lt;/div&gt;"+htmlstr;
                                //$("#home").html(htmlstr);
                                document.getElementById("video").pause();

                               // var strurl="http://wshls.mfniu.com/tjapp/"+teacher.hash+"_aac/playlist.m3u8";     //网速  目前使用
                                var strurl="http://hls.live.mfniu.com/tjapp/"+teacher.hash+"/index.m3u8"; //快网

                               // var strurl="http://123.130.117.41/v57463946-50454748__1771659_hls/playlist.m3u8";

                                //autoplay="autoplay"
                                $("videobox").html('&lt;video src="'+strurl+'" id="video" width="320" height="210" controls="controls" webkit-playsinline=""  preload="auto" poster="http://c.mfniu.com/MobileWeb/images/videoBg.png"&gt;&lt;/video&gt;');

                                $("video").attr("src",strurl);
                            var videoid= document.getElementById("video");
                            videoid.addEventListener("loadstart", function(obj)
                            {
                                //开始加载资源
                                //videoid.poster="./images/videoBg.png";
                            });
                            videoid.addEventListener("canplaythrough", function(obj)
                            {
                                //可以播放了
                                //videoid.poster="./images/videoBged.png";
                            });
                            videoid.addEventListener("play", function(obj)
                            {
                                //可以播放了
                                videoid.poster="";

                            });

                            document.getElementById("video").load();
                                document.getElementById("video").play();


                            //tab-content video-content

                            //document.getElementById("video").preload();



                            //document.getElementById("video").load();
                            //document.getElementById("video").play();
                            document.getElementById("video").addEventListener("error",function(obj){
                                var code=obj.srcElement.error.code;
                                console.log("111111111=============",code);
                                if(code!=4){
                                    document.getElementById("video").load();
                                }
                            },false);
                            /*
                            document.getElementById("video").addEventListener("playing",function(obj){
                                document.getElementById("video").play();
                            },false);
                            */

                            if ($(".userlist" + teacher.uid).length &lt; 1){  
                                $(".adminUserList").prepend('&lt;li class="clearfix userlist' + teacher.uid + '" nickname="' + teacher.nickname + '" uid="' + teacher.uid + '" type="'+teacher.type+'" area="room"&gt;&lt;a href="javascript:;"&gt;&lt;span&gt;' + teacher.nickname + '&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;');               
                            }
                        }
                    });
                }else{
                        //document.getElementById("video").preload();

                        //htmlstr="&lt;div&gt;=延时22 视频 切换视频&lt;/div&gt;"+htmlstr;

                       // $("#home").html(htmlstr);
						This.nowTeacher=res; //讲师信息
                        document.getElementById("video").pause();
                        //$("video2").attr("src","http://hls.live.mfniu.com/tjapp/"+teacher.hash+"/index.m3u8");
                        //$("video2").show();

                        //var serse="&lt;video src='http://hls.live.mfniu.com/tjapp/'"+res.hash+"'/index.m3u8' id='video' width='320' height='210' controls='controls' webkit-playsinline='' autoplay='autoplay' preload='auto' poster='images/videoBg.png'&gt;&lt;/video&gt;";

                        //debugger;


                       // var strurl="http://wshls.mfniu.com/tjapp/"+res.hash+"_aac/playlist.m3u8";     //网速
                        var strurl="http://hls.live.mfniu.com/tjapp/"+res.hash+"/index.m3u8"; //快网
                        //var streer='&lt;video src="'+strurl+'" id="video" width="320" height="210" controls="controls" webkit-playsinline="" autoplay="autoplay" preload="auto" poster="./images/videoBg.png"&gt;&lt;/video&gt;';
                       //alert(strurl);
                        //autoplay="autoplay"

                        //var strurl="http://123.130.117.41/v20745097-50456158__1772577_hls/playlist.m3u8";
                        $("videobox").html('&lt;video src="'+strurl+'" id="video" width="320" height="210" controls="controls" webkit-playsinline=""  preload="auto" poster="http://c.mfniu.com/MobileWeb/images/videoBg.png"&gt;&lt;/video&gt;');
                        $("video").attr("src",strurl);

                    var videoid= document.getElementById("video");

                    videoid.addEventListener("loadstart", function(obj)
                    {
                        //开始加载资源
                        //videoid.poster="./images/videoBg.png";

                    });
                    videoid.addEventListener("canplaythrough", function(obj)
                    {
                        //可以播放了
                        //videoid.poster="./images/videoBged.png";

                    });
                    videoid.addEventListener("play", function(obj)
                    {
                        //可以播放了
                        videoid.poster="";

                    });
                    document.getElementById("video").load();
                        document.getElementById("video").play();


                   // $("video").attr("src","http://hls.live.mfniu.com/tjapp/"+res.hash+"/index.m3u8");
                    //$("video").attr("src","http://117.121.31.196/mobilepage/media/ceshi.mp4"); //http://117.121.31.196/mobilepage/media/ceshi.mp4   http://123.130.117.40/v58525852-48069256__1004308_hls/playlist.m3u8
                    //document.getElementById("video").load();
                    //document.getElementById("video").preload();
                    //document.getElementById("video").play();
                    document.getElementById("video").addEventListener("playing",function(obj){
                        var code=obj.srcElement.error.code;
                        console.log("22222=============",code);
                        if(code!=4){
                            document.getElementById("video").load();
                        }
                    },false);

                    document.getElementById("video").addEventListener("error",function(obj){
                        var code=obj.srcElement.error.code;
                        console.log("33333=============",code);
                        if(code!=4){
                            document.getElementById("video").load();
                        }
                    },false);

                    //$("video").attr("src","http://hls.live.mfniu.com/tjapp/"+res.hash+"_aac/playlist.m3u8");
                    //$("video").attr("src","http://wshls.mfniu.com/tjapp/"+res.hash+"_aac/playlist.m3u8");
                    //$(".video-name").text(res.nickname);
                    if ($(".userlist" + res.uid).length &lt; 1){  
                        $(".adminUserList").prepend('&lt;li class="clearfix userlist' + res.uid + '" nickname="' + res.nickname + '" uid="' + res.uid + '" type="'+res.type+'" area="room"&gt;&lt;a href="javascript:;"&gt;&lt;span&gt;' + res.nickname + '&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;');               
                    }
                }
                /*if(notice){
                    setTimeout(function(){
                        $(".notice").html(notice);
                    },300);
                }  */
            });
        },
       
        run: function () {
            $("#room_broadcast").trigger("click");
            noticeTime = setTimeout(function(){
                if($(".broadcast-content").is(":visible")){
                    $("#room_broadcast").trigger("click");
                }
            },10000);
        },
       
        //房间公告
        roomNotice: function () {
            var notice = room.c_notice ? room.c_notice : "";
            var addstring = "";
            addstring += "&lt;div class='notice' &gt;"+notice+"&lt;/div&gt;";
            $(".notice").html(addstring);
        }
    }
    reborn.controller.RoomController = RoomController;
})()</pre></body></html>